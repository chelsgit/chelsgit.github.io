<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰™é†«è¨ºæ‰€æ’ç­ç³»çµ±</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #dbeafe;
            --success: #059669;
            --success-light: #d1fae5;
            --warning: #d97706;
            --warning-light: #fef3c7;
            --danger: #dc2626;
            --danger-light: #fee2e2;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --counter: #8b5cf6;
            --counter-light: #ede9fe;
            --follow: #0891b2;
            --follow-light: #cffafe;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            min-height: 100vh;
            color: var(--gray-800);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 24px 32px;
            border-radius: 16px;
            margin-bottom: 24px;
            box-shadow: 0 10px 40px rgba(37, 99, 235, 0.3);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            background: white;
            padding: 8px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            transition: all 0.2s;
            font-family: inherit;
        }

        .tab:hover {
            background: var(--gray-100);
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        /* Panels */
        .panel {
            display: none;
        }

        .panel.active {
            display: block;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.06);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--gray-200);
            flex-wrap: wrap;
            gap: 12px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-800);
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #047857;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: #b45309;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .btn-outline {
            background: white;
            border: 1px solid var(--gray-300);
            color: var(--gray-700);
        }

        .btn-outline:hover {
            background: var(--gray-50);
            border-color: var(--gray-400);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-lg {
            padding: 14px 28px;
            font-size: 16px;
        }

        /* Employee List */
        .employee-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        .employee-card {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
        }

        .employee-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
        }

        .employee-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 18px;
            flex-shrink: 0;
        }

        .employee-info {
            flex: 1;
            min-width: 0;
        }

        .employee-name {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 4px;
        }

        .employee-stats {
            font-size: 12px;
            color: var(--gray-500);
        }

        .employee-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
            flex-wrap: wrap;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        /* Schedule Table */
        .schedule-container {
            overflow-x: auto;
            margin-top: 16px;
        }

        .schedule-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            min-width: 1400px;
        }

        .schedule-table th,
        .schedule-table td {
            padding: 8px;
            text-align: center;
            border: 1px solid var(--gray-200);
        }

        .schedule-table th {
            background: var(--gray-100);
            font-weight: 600;
            font-size: 13px;
            color: var(--gray-700);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .schedule-table th:first-child {
            position: sticky;
            left: 0;
            z-index: 20;
            background: var(--gray-200);
            min-width: 100px;
        }

        .schedule-table td:first-child {
            position: sticky;
            left: 0;
            background: var(--gray-50);
            font-weight: 600;
            z-index: 5;
            min-width: 100px;
        }

        .day-header {
            min-width: 110px;
        }

        .day-header .date {
            font-size: 16px;
            font-weight: 700;
        }

        .day-header .weekday {
            font-size: 11px;
            color: var(--gray-500);
        }

        .day-header.holiday {
            background: #fef2f2 !important;
            color: #dc2626;
        }

        .day-header.holiday .date,
        .day-header.holiday .weekday {
            color: #dc2626 !important;
        }

        .day-header.saturday {
            background: var(--warning-light) !important;
        }

        .day-header.sunday {
            background: #fef2f2 !important;
            color: #dc2626;
        }

        .day-header.sunday .date,
        .day-header.sunday .weekday {
            color: #dc2626 !important;
        }

        .schedule-cell {
            min-height: 90px;
            vertical-align: top;
            padding: 8px !important;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .schedule-cell:hover {
            background: var(--primary-light);
        }

        .schedule-cell.no-session {
            background: var(--gray-100);
            color: var(--gray-400);
            cursor: default;
        }

        .schedule-cell.no-session:hover {
            background: var(--gray-100);
        }

        .staff-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            justify-content: center;
        }

        .staff-tag {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .staff-tag.counter {
            background: var(--counter-light);
            color: var(--counter);
            border: 1px solid var(--counter);
        }

        .staff-tag.follow {
            background: var(--follow-light);
            color: var(--follow);
            border: 1px solid var(--follow);
        }

        .vacancy-tag {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            background: var(--danger-light);
            color: var(--danger);
            border: 1px dashed var(--danger);
        }

        /* Session Labels */
        .session-label {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            margin-bottom: 4px;
        }

        .session-morning {
            background: #fef3c7;
            color: #92400e;
        }

        .session-afternoon {
            background: #dbeafe;
            color: #1e40af;
        }

        .session-evening {
            background: #e0e7ff;
            color: #3730a3;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .stat-card {
            background: var(--gray-50);
            border-radius: 10px;
            padding: 16px;
            text-align: center;
            border: 2px solid var(--gray-200);
            transition: all 0.3s;
        }

        .stat-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-target {
            font-size: 12px;
            color: var(--gray-500);
            margin-top: 4px;
        }

        .stat-card.complete {
            border-color: var(--success);
            background: var(--success-light);
        }

        .stat-card.complete .stat-value {
            color: var(--success);
        }

        .stat-card.over {
            border-color: var(--warning);
            background: var(--warning-light);
        }

        .stat-card.over .stat-value {
            color: var(--warning);
        }

        .stat-card.under .stat-value {
            color: var(--danger);
        }

        /* Leave Calendar */
        .leave-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            max-width: 500px;
        }

        .leave-calendar-header {
            text-align: center;
            font-weight: 600;
            font-size: 12px;
            color: var(--gray-600);
            padding: 8px;
        }

        .leave-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            border: 2px solid transparent;
            background: white;
        }

        .leave-day:hover:not(.empty):not(.sunday):not(.holiday) {
            background: var(--gray-100);
            border-color: var(--primary);
        }

        .leave-day.empty {
            cursor: default;
            background: transparent;
        }

        .leave-day.holiday {
            background: #fef2f2;
            color: #dc2626;
            cursor: not-allowed;
            font-weight: 600;
        }

        .leave-day.selected {
            background: var(--danger) !important;
            color: white !important;
            border-color: var(--danger) !important;
        }

        .leave-day.sunday {
            color: #dc2626;
            background: #fef2f2;
            cursor: not-allowed;
            font-weight: 600;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: all 0.3s;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal.modal-lg {
            max-width: 900px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--gray-100);
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            color: var(--gray-600);
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--gray-200);
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid var(--gray-200);
        }

        /* Action Bar */
        .action-bar {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        /* Legend */
        .legend {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-top: 16px;
            padding: 12px 16px;
            background: var(--gray-50);
            border-radius: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--gray-600);
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        /* Summary Panel */
        .summary-panel {
            background: linear-gradient(135deg, var(--gray-800) 0%, var(--gray-900) 100%);
            color: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-value {
            font-size: 32px;
            font-weight: 700;
        }

        .summary-label {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 4px;
        }

        /* Checkbox styling */
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: var(--gray-100);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            font-size: 14px;
        }

        .checkbox-label:hover {
            background: var(--gray-200);
        }

        .checkbox-label.checked {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .checkbox-label.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .checkbox-label input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--gray-800);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 2000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--danger);
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Personal Schedule Table */
        .personal-schedule-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .personal-schedule-table th,
        .personal-schedule-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid var(--gray-200);
        }

        .personal-schedule-table th {
            background: var(--gray-100);
            font-weight: 600;
        }

        .personal-schedule-table tr:nth-child(even) {
            background: var(--gray-50);
        }

        .personal-schedule-table .work-day {
            background: var(--success-light);
        }

        .personal-schedule-table .off-day {
            background: var(--gray-100);
            color: var(--gray-400);
        }

        .role-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .role-badge.counter {
            background: var(--counter-light);
            color: var(--counter);
        }

        .role-badge.follow {
            background: var(--follow-light);
            color: var(--follow);
        }

        /* Personal Stats */
        .personal-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .personal-stat-item {
            text-align: center;
            padding: 16px;
            background: var(--gray-50);
            border-radius: 10px;
        }

        .personal-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .personal-stat-label {
            font-size: 12px;
            color: var(--gray-500);
            margin-top: 4px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }
            
            .header {
                padding: 16px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .tabs {
                overflow-x: auto;
            }
            
            .tab {
                white-space: nowrap;
                padding: 10px 16px;
            }
            
            .action-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .btn-lg {
                width: 100%;
                justify-content: center;
            }

            .employee-actions {
                flex-direction: column;
            }
        }

        /* Print styles */
        @media print {
            body {
                background: white;
            }
            
            .tabs, .action-bar, .btn, .header, .legend {
                display: none !important;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #ddd;
            }

            .schedule-cell:hover {
                background: white;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¦· ç‰™é†«è¨ºæ‰€æ’ç­ç³»çµ±</h1>
            <p><span id="header-year-month">2026å¹´1æœˆ</span> åŠ©ç†ç­è¡¨ç®¡ç†</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('schedule')">ğŸ“… æ’ç­è¡¨</button>
            <button class="tab" onclick="switchTab('employees')">ğŸ‘¥ å“¡å·¥ç®¡ç†</button>
            <button class="tab" onclick="switchTab('leave')">ğŸ–ï¸ è«‹å‡è¨­å®š</button>
            <button class="tab" onclick="switchTab('personal')">ğŸ‘¤ å€‹äººç­è¡¨</button>
            <button class="tab" onclick="switchTab('stats')">ğŸ“Š çµ±è¨ˆå ±è¡¨</button>
            <button class="tab" onclick="switchTab('settings')">âš™ï¸ ç³»çµ±è¨­å®š</button>
        </div>

        <!-- Schedule Panel -->
        <div id="panel-schedule" class="panel active">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">åŠ©ç†ç­è¡¨ - <span id="schedule-year-month">2026å¹´1æœˆ</span></div>
                    <div class="action-bar">
                        <button class="btn btn-success btn-lg" onclick="autoSchedule()">
                            âš¡ ä¸€éµæ™ºèƒ½æ’ç­
                        </button>
                        <button class="btn btn-primary" onclick="exportToExcel()">
                            ğŸ“¥ åŒ¯å‡ºExcel
                        </button>
                        <button class="btn btn-outline" onclick="clearSchedule()">
                            ğŸ—‘ï¸ æ¸…é™¤ç­è¡¨
                        </button>
                        <button class="btn btn-outline" onclick="window.print()">
                            ğŸ–¨ï¸ åˆ—å°
                        </button>
                    </div>
                </div>

                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--counter-light); border: 1px solid var(--counter);"></div>
                        <span>æ«ƒæª¯ç­</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--follow-light); border: 1px solid var(--follow);"></div>
                        <span>è·Ÿè¨ºç­</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #fef3c7; border: 1px solid #f59e0b;"></div>
                        <span>æµå‹•ç­</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--danger-light); border: 1px dashed var(--danger);"></div>
                        <span>äººåŠ›ç¼ºé¡</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--gray-200);"></div>
                        <span>ä¼‘è¨º</span>
                    </div>
                </div>

                <div class="schedule-container">
                    <table class="schedule-table" id="schedule-table">
                        <!-- Generated by JS -->
                    </table>
                </div>
            </div>
        </div>

        <!-- Employees Panel -->
        <div id="panel-employees" class="panel">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">å“¡å·¥ç®¡ç†</div>
                    <button class="btn btn-primary" onclick="openAddEmployeeModal()">
                        â• æ–°å¢å“¡å·¥
                    </button>
                </div>
                <p style="color: var(--gray-500); font-size: 14px; margin-bottom: 16px;">
                    ğŸ’¡ å¯è¨­å®šå“¡å·¥é è¨­è·ä½ï¼ˆæ«ƒæª¯/è·Ÿè¨ºå¯è¤‡é¸ï¼‰ï¼Œæ™ºèƒ½æ’ç­æ™‚æœƒå„ªå…ˆä¾ç…§é è¨­è·ä½åˆ†é…
                </p>
                <div class="employee-grid" id="employee-list">
                    <!-- Generated by JS -->
                </div>
            </div>
        </div>

        <!-- Leave Panel -->
        <div id="panel-leave" class="panel">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">è«‹å‡è¨­å®š - <span id="leave-year-month">2026å¹´1æœˆ</span></div>
                    <div class="action-bar">
                        <select class="form-input" style="width: auto; min-width: 150px;" id="leave-employee-select" onchange="renderLeaveCalendar()">
                            <!-- Generated by JS -->
                        </select>
                        <button class="btn btn-outline" onclick="clearEmployeeLeave()">æ¸…é™¤æ­¤å“¡å·¥è«‹å‡</button>
                    </div>
                </div>
                <p style="color: var(--gray-500); font-size: 14px; margin-bottom: 16px;">
                    ğŸ’¡ é»æ“Šæ—¥æœŸå¯æ¨™è¨˜è©²å“¡å·¥ä¸èƒ½ä¸Šç­çš„æ—¥æœŸï¼ˆç´…è‰²ç‚ºå·²è«‹å‡ï¼‰
                </p>
                <div class="leave-calendar" id="leave-calendar">
                    <!-- Generated by JS -->
                </div>
                <div id="leave-summary" style="margin-top: 20px; padding: 16px; background: var(--gray-50); border-radius: 8px;">
                    <!-- Generated by JS -->
                </div>
            </div>
        </div>

        <!-- Personal Schedule Panel -->
        <div id="panel-personal" class="panel">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">ğŸ‘¤ å€‹äººç­è¡¨æª¢è¦–</div>
                    <div class="action-bar">
                        <select class="form-input" style="width: auto; min-width: 150px;" id="personal-employee-select" onchange="renderPersonalSchedule()">
                            <!-- Generated by JS -->
                        </select>
                        <button class="btn btn-primary" onclick="exportPersonalExcel()">
                            ğŸ“¥ åŒ¯å‡ºå€‹äººç­è¡¨
                        </button>
                    </div>
                </div>
                <div id="personal-schedule-content">
                    <!-- Generated by JS -->
                </div>
            </div>
        </div>

        <!-- Stats Panel -->
        <div id="panel-stats" class="panel">
            <div class="summary-panel">
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-value" id="total-sessions">71</div>
                        <div class="summary-label">æœ¬æœˆç¸½è¨ºæ•¸</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="total-required">284</div>
                        <div class="summary-label">éœ€æ±‚äººæ¬¡</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="total-assigned">0</div>
                        <div class="summary-label">å·²æ’äººæ¬¡</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="total-vacancy">284</div>
                        <div class="summary-label">ç¼ºé¡äººæ¬¡</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">å“¡å·¥è¨ºæ•¸çµ±è¨ˆ</div>
                    <div class="action-bar">
                        <span style="color: var(--gray-500); font-size: 14px;">ç›®æ¨™ï¼šæ¯äºº <span id="stats-target-display">42</span> è¨º</span>
                        <button class="btn btn-primary" onclick="exportStatsExcel()">
                            ğŸ“¥ åŒ¯å‡ºçµ±è¨ˆå ±è¡¨
                        </button>
                    </div>
                </div>
                <div class="stats-grid" id="stats-grid">
                    <!-- Generated by JS -->
                </div>
            </div>
        </div>

        <!-- Settings Panel -->
        <div id="panel-settings" class="panel">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">âš™ï¸ ç³»çµ±è¨­å®š</div>
                </div>

                <!-- å¹´æœˆè¨­å®š -->
                <div style="margin-bottom: 24px;">
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px; color: var(--gray-700);">
                        ğŸ“… æ’ç­å¹´æœˆ
                    </h3>
                    <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                        <select id="year-select" class="form-input" style="width: 120px;" onchange="changeYearMonth()">
                            <option value="2024">2024 å¹´</option>
                            <option value="2025">2025 å¹´</option>
                            <option value="2026" selected>2026 å¹´</option>
                            <option value="2027">2027 å¹´</option>
                        </select>
                        <select id="month-select" class="form-input" style="width: 100px;" onchange="changeYearMonth()">
                            <option value="1">1 æœˆ</option>
                            <option value="2">2 æœˆ</option>
                            <option value="3">3 æœˆ</option>
                            <option value="4">4 æœˆ</option>
                            <option value="5">5 æœˆ</option>
                            <option value="6">6 æœˆ</option>
                            <option value="7">7 æœˆ</option>
                            <option value="8">8 æœˆ</option>
                            <option value="9">9 æœˆ</option>
                            <option value="10">10 æœˆ</option>
                            <option value="11">11 æœˆ</option>
                            <option value="12">12 æœˆ</option>
                        </select>
                        <button class="btn btn-outline" onclick="changeYearMonth()" style="padding: 8px 16px;">
                            ğŸ”„ åˆ‡æ›æœˆä»½
                        </button>
                    </div>
                    <p style="font-size: 12px; color: var(--danger); margin-top: 8px;">
                        âš ï¸ åˆ‡æ›å¹´æœˆå°‡æ¸…é™¤ç¾æœ‰ç­è¡¨è³‡æ–™
                    </p>
                </div>

                <!-- æœ¬æœˆåœ‹å®šå‡æ—¥ -->
                <div style="margin-bottom: 24px;">
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px; color: var(--gray-700);">
                        ğŸŒ æœ¬æœˆåœ‹å®šå‡æ—¥
                    </h3>
                    <div id="holiday-list" style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <!-- Generated by JS -->
                    </div>
                </div>
                
                <!-- ç›®æ¨™è¨ºæ•¸è¨­å®š -->
                <div style="margin-bottom: 24px;">
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px; color: var(--gray-700);">
                        ğŸ¯ æ¯äººç›®æ¨™è¨ºæ•¸
                    </h3>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <input type="number" id="target-sessions-input" class="form-input" 
                               style="width: 100px;" min="1" max="100" value="42"
                               onchange="updateTargetSessions()">
                        <span style="color: var(--gray-500);">è¨º/æœˆ</span>
                        <span style="font-size: 12px; color: var(--gray-400);">ï¼ˆå»ºè­°å€¼ï¼š35-50ï¼‰</span>
                    </div>
                </div>

                <!-- å„æ™‚æ®µäººåŠ›éœ€æ±‚è¨­å®š -->
                <div style="margin-bottom: 24px;">
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px; color: var(--gray-700);">
                        ğŸ‘¥ å„æ™‚æ®µäººåŠ›éœ€æ±‚
                    </h3>
                    <p style="font-size: 12px; color: var(--gray-500); margin-bottom: 16px;">
                        è¨­å®šæ¯å€‹æ™‚æ®µæ‰€éœ€çš„æ«ƒæª¯ã€è·Ÿè¨ºã€æµå‹•äººæ•¸ï¼ˆæ’ç­è¦å‰‡ï¼šæ¯è¨ºè‡³å°‘éœ€æœ‰1äººï¼‰
                    </p>
                    
                    <div style="display: grid; gap: 16px;">
                        <!-- æ—©è¨º -->
                        <div style="padding: 16px; background: #fef3c7; border-radius: 12px; border: 1px solid #fcd34d;">
                            <div style="font-weight: 600; color: #92400e; margin-bottom: 12px;">ğŸŒ… æ—©è¨º (09:30-12:30)</div>
                            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="width: 50px; font-size: 13px;">æ«ƒæª¯</span>
                                    <input type="number" id="morning-counter" class="form-input" 
                                           style="width: 70px;" min="0" max="10" value="1"
                                           onchange="updateStaffSettings()">
                                    <span style="font-size: 12px; color: var(--gray-500);">äºº</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="width: 50px; font-size: 13px;">è·Ÿè¨º</span>
                                    <input type="number" id="morning-follow" class="form-input" 
                                           style="width: 70px;" min="0" max="10" value="3"
                                           onchange="updateStaffSettings()">
                                    <span style="font-size: 12px; color: var(--gray-500);">äºº</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="width: 50px; font-size: 13px;">æµå‹•</span>
                                    <input type="number" id="morning-floater" class="form-input" 
                                           style="width: 70px;" min="0" max="10" value="0"
                                           onchange="updateStaffSettings()">
                                    <span style="font-size: 12px; color: var(--gray-500);">äºº</span>
                                </div>
                            </div>
                        </div>

                        <!-- åˆè¨º -->
                        <div style="padding: 16px; background: #dbeafe; border-radius: 12px; border: 1px solid #93c5fd;">
                            <div style="font-weight: 600; color: #1e40af; margin-bottom: 12px;">â˜€ï¸ åˆè¨º (14:00-17:30)</div>
                            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="width: 50px; font-size: 13px;">æ«ƒæª¯</span>
                                    <input type="number" id="afternoon-counter" class="form-input" 
                                           style="width: 70px;" min="0" max="10" value="1"
                                           onchange="updateStaffSettings()">
                                    <span style="font-size: 12px; color: var(--gray-500);">äºº</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="width: 50px; font-size: 13px;">è·Ÿè¨º</span>
                                    <input type="number" id="afternoon-follow" class="form-input" 
                                           style="width: 70px;" min="0" max="10" value="3"
                                           onchange="updateStaffSettings()">
                                    <span style="font-size: 12px; color: var(--gray-500);">äºº</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="width: 50px; font-size: 13px;">æµå‹•</span>
                                    <input type="number" id="afternoon-floater" class="form-input" 
                                           style="width: 70px;" min="0" max="10" value="0"
                                           onchange="updateStaffSettings()">
                                    <span style="font-size: 12px; color: var(--gray-500);">äºº</span>
                                </div>
                            </div>
                        </div>

                        <!-- æ™šè¨º -->
                        <div style="padding: 16px; background: #e0e7ff; border-radius: 12px; border: 1px solid #a5b4fc;">
                            <div style="font-weight: 600; color: #3730a3; margin-bottom: 12px;">ğŸŒ™ æ™šè¨º (18:00-21:30)</div>
                            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="width: 50px; font-size: 13px;">æ«ƒæª¯</span>
                                    <input type="number" id="evening-counter" class="form-input" 
                                           style="width: 70px;" min="0" max="10" value="1"
                                           onchange="updateStaffSettings()">
                                    <span style="font-size: 12px; color: var(--gray-500);">äºº</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="width: 50px; font-size: 13px;">è·Ÿè¨º</span>
                                    <input type="number" id="evening-follow" class="form-input" 
                                           style="width: 70px;" min="0" max="10" value="3"
                                           onchange="updateStaffSettings()">
                                    <span style="font-size: 12px; color: var(--gray-500);">äºº</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="width: 50px; font-size: 13px;">æµå‹•</span>
                                    <input type="number" id="evening-floater" class="form-input" 
                                           style="width: 70px;" min="0" max="10" value="0"
                                           onchange="updateStaffSettings()">
                                    <span style="font-size: 12px; color: var(--gray-500);">äºº</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- äººåŠ›è¨ˆç®—æ‘˜è¦ -->
                <div style="padding: 20px; background: var(--gray-100); border-radius: 12px;">
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--gray-700);">
                        ğŸ“Š äººåŠ›è¨ˆç®—æ‘˜è¦
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;" id="settings-summary">
                        <!-- Generated by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Employee Modal -->
    <div class="modal-overlay" id="employee-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="employee-modal-title">æ–°å¢å“¡å·¥</div>
                <button class="modal-close" onclick="closeModal('employee-modal')">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">å“¡å·¥å§“å</label>
                <input type="text" class="form-input" id="employee-name-input" placeholder="è«‹è¼¸å…¥å§“å">
            </div>
            <div class="form-group">
                <label class="form-label">é è¨­è·ä½ï¼ˆå¯è¤‡é¸ï¼‰</label>
                <p style="font-size: 12px; color: var(--gray-500); margin-bottom: 10px;">
                    æ™ºèƒ½æ’ç­æ™‚æœƒå„ªå…ˆå°‡å“¡å·¥åˆ†é…åˆ°é è¨­è·ä½
                </p>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <label id="role-counter-label" style="display: flex; align-items: center; gap: 8px; padding: 12px 16px; border-radius: 10px; cursor: pointer; border: 2px solid var(--gray-200); background: var(--gray-50); transition: all 0.2s;">
                        <input type="checkbox" id="role-counter-input" onchange="updateRoleCheckboxStyle()">
                        <span style="width: 24px; height: 24px; border-radius: 6px; background: var(--counter); color: white; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">æ«ƒ</span>
                        <span style="font-weight: 500;">æ«ƒæª¯ç­</span>
                    </label>
                    <label id="role-follow-label" style="display: flex; align-items: center; gap: 8px; padding: 12px 16px; border-radius: 10px; cursor: pointer; border: 2px solid var(--gray-200); background: var(--gray-50); transition: all 0.2s;">
                        <input type="checkbox" id="role-follow-input" onchange="updateRoleCheckboxStyle()">
                        <span style="width: 24px; height: 24px; border-radius: 6px; background: var(--follow); color: white; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">è¨º</span>
                        <span style="font-weight: 500;">è·Ÿè¨ºç­</span>
                    </label>
                    <label id="role-floater-label" style="display: flex; align-items: center; gap: 8px; padding: 12px 16px; border-radius: 10px; cursor: pointer; border: 2px solid var(--gray-200); background: var(--gray-50); transition: all 0.2s;">
                        <input type="checkbox" id="role-floater-input" onchange="updateRoleCheckboxStyle()">
                        <span style="width: 24px; height: 24px; border-radius: 6px; background: #f59e0b; color: white; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">æµ</span>
                        <span style="font-weight: 500;">æµå‹•ç­</span>
                    </label>
                </div>
            </div>
            <input type="hidden" id="employee-edit-id">
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('employee-modal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveEmployee()">å„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- Cell Edit Modal -->
    <div class="modal-overlay" id="cell-edit-modal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-title" id="cell-edit-title">ç·¨è¼¯ç­æ¬¡</div>
                <button class="modal-close" onclick="closeModal('cell-edit-modal')">&times;</button>
            </div>
            <div id="cell-edit-content">
                <!-- Generated by JS -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal('cell-edit-modal')">å®Œæˆ</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ===== DATA =====
        // roles: { counter, follow, floater } é è¨­è·ä½ï¼ˆå¯è¤‡é¸ï¼‰
        let employees = [
            { id: 1, name: 'ç‹å°ç¾', roles: { counter: true, follow: false, floater: false } },
            { id: 2, name: 'æ—ä½³ç²', roles: { counter: true, follow: true, floater: false } },
            { id: 3, name: 'é™³é›…å©·', roles: { counter: false, follow: true, floater: false } },
            { id: 4, name: 'å¼µæƒ å›', roles: { counter: false, follow: true, floater: true } },
            { id: 5, name: 'æç¾ç²', roles: { counter: false, follow: true, floater: false } },
            { id: 6, name: 'é»ƒæ·‘èŠ¬', roles: { counter: true, follow: true, floater: true } }
        ];

        let leaves = {}; // { å“¡å·¥ID: [æ—¥æœŸé™£åˆ—] }

        // æ–°å¢ floater æ¬„ä½
        let schedule = {}; // { 'YYYY-MM-DD_session': { counter: [å“¡å·¥ID], follow: [å“¡å·¥ID], floater: [å“¡å·¥ID] } }

        // å¯æ›´æ”¹çš„å¹´æœˆ
        let currentYear = 2026;
        let currentMonth = 1;
        
        // å¯èª¿æ•´çš„è¨­å®š
        let settings = {
            targetSessions: 42, // æ¯äººç›®æ¨™è¨ºæ•¸
            staffPerSession: {
                morning: { counter: 1, follow: 3, floater: 0 },
                afternoon: { counter: 1, follow: 3, floater: 0 },
                evening: { counter: 1, follow: 3, floater: 0 }
            }
        };

        // å°ç£åœ‹å®šå‡æ—¥è³‡æ–™åº« (2024-2027)
        const TAIWAN_HOLIDAYS = {
            // 2024å¹´
            '2024-01-01': 'å…ƒæ—¦',
            '2024-02-08': 'è¾²æ›†é™¤å¤•',
            '2024-02-09': 'æ˜¥ç¯€',
            '2024-02-10': 'æ˜¥ç¯€',
            '2024-02-11': 'æ˜¥ç¯€',
            '2024-02-12': 'æ˜¥ç¯€ï¼ˆèª¿æ•´æ”¾å‡ï¼‰',
            '2024-02-13': 'æ˜¥ç¯€ï¼ˆèª¿æ•´æ”¾å‡ï¼‰',
            '2024-02-14': 'æ˜¥ç¯€ï¼ˆèª¿æ•´æ”¾å‡ï¼‰',
            '2024-02-28': 'å’Œå¹³ç´€å¿µæ—¥',
            '2024-04-04': 'å…’ç«¥ç¯€',
            '2024-04-05': 'æ¸…æ˜ç¯€',
            '2024-05-01': 'å‹å‹•ç¯€',
            '2024-06-10': 'ç«¯åˆç¯€',
            '2024-09-17': 'ä¸­ç§‹ç¯€',
            '2024-10-10': 'åœ‹æ…¶æ—¥',
            
            // 2025å¹´
            '2025-01-01': 'å…ƒæ—¦',
            '2025-01-27': 'è¾²æ›†é™¤å¤•ï¼ˆèª¿æ•´æ”¾å‡ï¼‰',
            '2025-01-28': 'è¾²æ›†é™¤å¤•',
            '2025-01-29': 'æ˜¥ç¯€',
            '2025-01-30': 'æ˜¥ç¯€',
            '2025-01-31': 'æ˜¥ç¯€',
            '2025-02-01': 'æ˜¥ç¯€ï¼ˆèª¿æ•´æ”¾å‡ï¼‰',
            '2025-02-28': 'å’Œå¹³ç´€å¿µæ—¥',
            '2025-04-03': 'å…’ç«¥ç¯€ï¼ˆèª¿æ•´æ”¾å‡ï¼‰',
            '2025-04-04': 'å…’ç«¥ç¯€/æ¸…æ˜ç¯€',
            '2025-05-01': 'å‹å‹•ç¯€',
            '2025-05-30': 'ç«¯åˆç¯€ï¼ˆèª¿æ•´æ”¾å‡ï¼‰',
            '2025-05-31': 'ç«¯åˆç¯€',
            '2025-10-06': 'ä¸­ç§‹ç¯€',
            '2025-10-10': 'åœ‹æ…¶æ—¥',
            
            // 2026å¹´
            '2026-01-01': 'å…ƒæ—¦',
            '2026-01-02': 'å…ƒæ—¦ï¼ˆèª¿æ•´æ”¾å‡ï¼‰',
            '2026-02-16': 'è¾²æ›†é™¤å¤•ï¼ˆèª¿æ•´æ”¾å‡ï¼‰',
            '2026-02-17': 'è¾²æ›†é™¤å¤•',
            '2026-02-18': 'æ˜¥ç¯€',
            '2026-02-19': 'æ˜¥ç¯€',
            '2026-02-20': 'æ˜¥ç¯€',
            '2026-02-28': 'å’Œå¹³ç´€å¿µæ—¥',
            '2026-04-03': 'å…’ç«¥ç¯€ï¼ˆèª¿æ•´æ”¾å‡ï¼‰',
            '2026-04-04': 'å…’ç«¥ç¯€',
            '2026-04-05': 'æ¸…æ˜ç¯€',
            '2026-04-06': 'æ¸…æ˜ç¯€ï¼ˆèª¿æ•´æ”¾å‡ï¼‰',
            '2026-05-01': 'å‹å‹•ç¯€',
            '2026-06-19': 'ç«¯åˆç¯€',
            '2026-09-25': 'ä¸­ç§‹ç¯€',
            '2026-10-09': 'åœ‹æ…¶æ—¥ï¼ˆèª¿æ•´æ”¾å‡ï¼‰',
            '2026-10-10': 'åœ‹æ…¶æ—¥',
            
            // 2027å¹´
            '2027-01-01': 'å…ƒæ—¦',
            '2027-02-05': 'è¾²æ›†é™¤å¤•ï¼ˆèª¿æ•´æ”¾å‡ï¼‰',
            '2027-02-06': 'è¾²æ›†é™¤å¤•',
            '2027-02-07': 'æ˜¥ç¯€',
            '2027-02-08': 'æ˜¥ç¯€',
            '2027-02-09': 'æ˜¥ç¯€',
            '2027-02-10': 'æ˜¥ç¯€ï¼ˆèª¿æ•´æ”¾å‡ï¼‰',
            '2027-02-28': 'å’Œå¹³ç´€å¿µæ—¥',
            '2027-03-01': 'å’Œå¹³ç´€å¿µæ—¥ï¼ˆèª¿æ•´æ”¾å‡ï¼‰',
            '2027-04-04': 'å…’ç«¥ç¯€',
            '2027-04-05': 'æ¸…æ˜ç¯€',
            '2027-04-06': 'æ¸…æ˜ç¯€ï¼ˆèª¿æ•´æ”¾å‡ï¼‰',
            '2027-05-01': 'å‹å‹•ç¯€',
            '2027-06-09': 'ç«¯åˆç¯€',
            '2027-09-15': 'ä¸­ç§‹ç¯€',
            '2027-10-10': 'åœ‹æ…¶æ—¥',
            '2027-10-11': 'åœ‹æ…¶æ—¥ï¼ˆèª¿æ•´æ”¾å‡ï¼‰'
        };

        const SESSIONS = ['morning', 'afternoon', 'evening'];
        const SESSION_NAMES = { morning: 'æ—©è¨º', afternoon: 'åˆè¨º', evening: 'æ™šè¨º' };
        const SESSION_TIMES = { 
            morning: '09:30-12:30', 
            afternoon: '14:00-17:30', 
            evening: '18:00-21:30' 
        };

        // ===== UTILITIES =====
        function getDaysInMonth(year, month) {
            return new Date(year, month, 0).getDate();
        }

        function getWeekday(year, month, day) {
            return new Date(year, month - 1, day).getDay();
        }

        function formatDate(day) {
            return `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        }

        function isHoliday(dateStr) {
            return TAIWAN_HOLIDAYS.hasOwnProperty(dateStr);
        }

        function getHolidayName(dateStr) {
            return TAIWAN_HOLIDAYS[dateStr] || '';
        }

        function isSunday(day) {
            return getWeekday(currentYear, currentMonth, day) === 0;
        }

        function isSaturday(day) {
            return getWeekday(currentYear, currentMonth, day) === 6;
        }

        function getSessionsForDay(day) {
            if (isSunday(day) || isHoliday(formatDate(day))) return [];
            if (isSaturday(day)) return ['morning', 'afternoon'];
            return ['morning', 'afternoon', 'evening'];
        }

        function getWeekdayName(day) {
            const names = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            return names[getWeekday(currentYear, currentMonth, day)];
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type + ' show';
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function showLoading() {
            document.getElementById('loading-overlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.remove('active');
        }

        function getRoleDisplay(emp) {
            const roles = emp.roles || { counter: false, follow: false, floater: false };
            const parts = [];
            if (roles.counter) parts.push('æ«ƒæª¯');
            if (roles.follow) parts.push('è·Ÿè¨º');
            if (roles.floater) parts.push('æµå‹•');
            return parts.length > 0 ? parts.join(' + ') : 'æœªè¨­å®š';
        }

        // è¨ˆç®—ç¸½éœ€æ±‚äººæ¬¡
        function calculateTotalRequired() {
            const daysInMonth = getDaysInMonth(currentYear, currentMonth);
            let total = 0;
            for (let day = 1; day <= daysInMonth; day++) {
                const sessions = getSessionsForDay(day);
                sessions.forEach(session => {
                    const staffReq = settings.staffPerSession[session];
                    total += staffReq.counter + staffReq.follow + staffReq.floater;
                });
            }
            return total;
        }

        // å–å¾—æŸæ™‚æ®µçš„äººåŠ›éœ€æ±‚
        function getStaffRequirement(session) {
            return settings.staffPerSession[session];
        }

        // ===== EMPLOYEE MANAGEMENT =====
        function renderEmployeeList() {
            const container = document.getElementById('employee-list');
            container.innerHTML = employees.map(emp => {
                const sessionCount = countEmployeeSessions(emp.id);
                const target = settings.targetSessions;
                const statusText = sessionCount >= target ? 'âœ“ å·²é”æ¨™' : `å·® ${target - sessionCount} è¨º`;
                const statusColor = sessionCount >= target ? 'var(--success)' : 'var(--danger)';
                const roles = emp.roles || { counter: false, follow: false, floater: false };
                
                let roleTags = '';
                if (roles.counter) {
                    roleTags += '<span style="display:inline-block;padding:3px 8px;border-radius:10px;font-size:11px;background:var(--counter-light);color:var(--counter);border:1px solid var(--counter);margin-right:4px;">æ«ƒæª¯</span>';
                }
                if (roles.follow) {
                    roleTags += '<span style="display:inline-block;padding:3px 8px;border-radius:10px;font-size:11px;background:var(--follow-light);color:var(--follow);border:1px solid var(--follow);margin-right:4px;">è·Ÿè¨º</span>';
                }
                if (roles.floater) {
                    roleTags += '<span style="display:inline-block;padding:3px 8px;border-radius:10px;font-size:11px;background:#fef3c7;color:#d97706;border:1px solid #f59e0b;">æµå‹•</span>';
                }
                if (!roles.counter && !roles.follow && !roles.floater) {
                    roleTags = '<span style="display:inline-block;padding:3px 8px;border-radius:10px;font-size:11px;background:var(--gray-100);color:var(--gray-500);border:1px solid var(--gray-300);">æœªè¨­å®š</span>';
                }
                
                return `
                    <div class="employee-card">
                        <div class="employee-avatar">${emp.name.charAt(0)}</div>
                        <div class="employee-info">
                            <div class="employee-name">${emp.name}</div>
                            <div class="employee-stats">
                                å·²æ’ <strong>${sessionCount}</strong> è¨º / ç›®æ¨™ ${target} è¨º
                                <span style="color: ${statusColor}; margin-left: 8px;">${statusText}</span>
                            </div>
                            <div style="margin-top:6px;">
                                <span style="font-size:11px;color:var(--gray-500);">é è¨­ï¼š</span>${roleTags}
                            </div>
                        </div>
                        <div class="employee-actions">
                            <button class="btn btn-outline btn-sm" onclick="viewPersonalSchedule(${emp.id})">ğŸ“… ç­è¡¨</button>
                            <button class="btn btn-outline btn-sm" onclick="editEmployee(${emp.id})">âœï¸ ç·¨è¼¯</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteEmployee(${emp.id})">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `;
            }).join('');

            // Update selects
            updateEmployeeSelects();
        }

        function updateEmployeeSelects() {
            const leaveSelect = document.getElementById('leave-employee-select');
            const personalSelect = document.getElementById('personal-employee-select');
            
            const options = employees.map(emp => 
                `<option value="${emp.id}">${emp.name}</option>`
            ).join('');
            
            const currentLeave = leaveSelect.value;
            const currentPersonal = personalSelect.value;
            
            leaveSelect.innerHTML = options;
            personalSelect.innerHTML = options;
            
            if (currentLeave && employees.find(e => e.id === parseInt(currentLeave))) {
                leaveSelect.value = currentLeave;
            }
            if (currentPersonal && employees.find(e => e.id === parseInt(currentPersonal))) {
                personalSelect.value = currentPersonal;
            }
        }

        function openAddEmployeeModal() {
            document.getElementById('employee-modal-title').textContent = 'æ–°å¢å“¡å·¥';
            document.getElementById('employee-name-input').value = '';
            document.getElementById('employee-edit-id').value = '';
            // Reset role checkboxes - default to follow
            document.getElementById('role-counter-input').checked = false;
            document.getElementById('role-follow-input').checked = true;
            document.getElementById('role-floater-input').checked = false;
            updateRoleCheckboxStyle();
            openModal('employee-modal');
            document.getElementById('employee-name-input').focus();
        }

        function updateRoleCheckboxStyle() {
            const counterInput = document.getElementById('role-counter-input');
            const followInput = document.getElementById('role-follow-input');
            const floaterInput = document.getElementById('role-floater-input');
            const counterLabel = document.getElementById('role-counter-label');
            const followLabel = document.getElementById('role-follow-label');
            const floaterLabel = document.getElementById('role-floater-label');
            
            if (counterInput.checked) {
                counterLabel.style.borderColor = 'var(--counter)';
                counterLabel.style.background = 'var(--counter-light)';
            } else {
                counterLabel.style.borderColor = 'var(--gray-200)';
                counterLabel.style.background = 'var(--gray-50)';
            }
            
            if (followInput.checked) {
                followLabel.style.borderColor = 'var(--follow)';
                followLabel.style.background = 'var(--follow-light)';
            } else {
                followLabel.style.borderColor = 'var(--gray-200)';
                followLabel.style.background = 'var(--gray-50)';
            }

            if (floaterInput.checked) {
                floaterLabel.style.borderColor = '#f59e0b';
                floaterLabel.style.background = '#fef3c7';
            } else {
                floaterLabel.style.borderColor = 'var(--gray-200)';
                floaterLabel.style.background = 'var(--gray-50)';
            }
        }

        function editEmployee(id) {
            const emp = employees.find(e => e.id === id);
            if (!emp) return;
            
            document.getElementById('employee-modal-title').textContent = 'ç·¨è¼¯å“¡å·¥';
            document.getElementById('employee-name-input').value = emp.name;
            document.getElementById('employee-edit-id').value = id;
            
            // Set role checkboxes based on employee data
            const roles = emp.roles || { counter: false, follow: false, floater: false };
            document.getElementById('role-counter-input').checked = roles.counter;
            document.getElementById('role-follow-input').checked = roles.follow;
            document.getElementById('role-floater-input').checked = roles.floater || false;
            updateRoleCheckboxStyle();
            
            openModal('employee-modal');
            document.getElementById('employee-name-input').focus();
        }

        function saveEmployee() {
            const name = document.getElementById('employee-name-input').value.trim();
            const editId = document.getElementById('employee-edit-id').value;
            const counterRole = document.getElementById('role-counter-input').checked;
            const followRole = document.getElementById('role-follow-input').checked;
            const floaterRole = document.getElementById('role-floater-input').checked;

            if (!name) {
                showToast('è«‹è¼¸å…¥å“¡å·¥å§“å', 'error');
                return;
            }

            const roles = { counter: counterRole, follow: followRole, floater: floaterRole };

            if (editId) {
                const emp = employees.find(e => e.id === parseInt(editId));
                if (emp) {
                    emp.name = name;
                    emp.roles = roles;
                    showToast(`å“¡å·¥ã€Œ${name}ã€å·²æ›´æ–°`);
                }
            } else {
                const maxId = employees.reduce((max, e) => Math.max(max, e.id), 0);
                employees.push({ id: maxId + 1, name, roles });
                showToast(`å“¡å·¥ã€Œ${name}ã€å·²æ–°å¢`);
            }

            closeModal('employee-modal');
            renderAll();
        }

        function deleteEmployee(id) {
            const emp = employees.find(e => e.id === id);
            if (!emp) return;
            
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤å“¡å·¥ã€Œ${emp.name}ã€å—ï¼Ÿ\nç›¸é—œæ’ç­è³‡æ–™ä¹Ÿæœƒè¢«æ¸…é™¤ã€‚`)) return;
            
            employees = employees.filter(e => e.id !== id);
            delete leaves[id];
            
            // Remove from schedule
            Object.keys(schedule).forEach(key => {
                if (schedule[key]) {
                    schedule[key].counter = schedule[key].counter.filter(eid => eid !== id);
                    schedule[key].follow = schedule[key].follow.filter(eid => eid !== id);
                }
            });

            showToast(`å“¡å·¥ã€Œ${emp.name}ã€å·²åˆªé™¤`);
            renderAll();
        }

        function viewPersonalSchedule(empId) {
            document.getElementById('personal-employee-select').value = empId;
            switchTab('personal');
            renderPersonalSchedule();
        }

        // ===== LEAVE MANAGEMENT =====
        function renderLeaveCalendar() {
            const container = document.getElementById('leave-calendar');
            const empId = parseInt(document.getElementById('leave-employee-select').value);
            
            if (!empId) {
                container.innerHTML = '<p style="color: var(--gray-500);">è«‹å…ˆé¸æ“‡å“¡å·¥</p>';
                return;
            }
            
            const empLeaves = leaves[empId] || [];
            const emp = employees.find(e => e.id === empId);

            const daysInMonth = getDaysInMonth(currentYear, currentMonth);
            const firstDay = getWeekday(currentYear, currentMonth, 1);

            let html = `
                <div class="leave-calendar-header" style="color: #dc2626;">æ—¥</div>
                <div class="leave-calendar-header">ä¸€</div>
                <div class="leave-calendar-header">äºŒ</div>
                <div class="leave-calendar-header">ä¸‰</div>
                <div class="leave-calendar-header">å››</div>
                <div class="leave-calendar-header">äº”</div>
                <div class="leave-calendar-header" style="color: #2563eb;">å…­</div>
            `;

            for (let i = 0; i < firstDay; i++) {
                html += '<div class="leave-day empty"></div>';
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = formatDate(day);
                const sunday = isSunday(day);
                const holiday = isHoliday(dateStr);
                const selected = empLeaves.includes(dateStr);
                
                let classes = 'leave-day';
                if (sunday) classes += ' sunday';
                if (holiday) classes += ' holiday';
                if (selected) classes += ' selected';

                const clickable = !sunday && !holiday;
                const holidayName = getHolidayName(dateStr);
                const title = holiday ? `åœ‹å®šå‡æ—¥ï¼š${holidayName}` : (sunday ? 'é€±æ—¥ä¼‘è¨º' : (selected ? 'å·²è«‹å‡ - é»æ“Šå–æ¶ˆ' : 'é»æ“Šè¨­å®šè«‹å‡'));
                
                html += `
                    <div class="${classes}" 
                         title="${title}"
                         ${clickable ? `onclick="toggleLeave(${day})"` : ''}>
                        ${day}
                    </div>
                `;
            }

            container.innerHTML = html;

            const summaryEl = document.getElementById('leave-summary');
            const leaveDays = empLeaves.length;
            summaryEl.innerHTML = `
                <strong>${emp ? emp.name : ''}</strong> æœ¬æœˆè«‹å‡ï¼š<strong style="color: ${leaveDays > 0 ? 'var(--danger)' : 'var(--success)'};">${leaveDays}</strong> å¤©
                ${leaveDays > 0 ? `<br><small style="color: var(--gray-500);">è«‹å‡æ—¥æœŸï¼š${empLeaves.map(d => d.split('-')[2]).join(', ')} æ—¥</small>` : ''}
            `;
        }

        function toggleLeave(day) {
            const empId = parseInt(document.getElementById('leave-employee-select').value);
            const dateStr = formatDate(day);

            if (!leaves[empId]) leaves[empId] = [];

            const idx = leaves[empId].indexOf(dateStr);
            if (idx > -1) {
                leaves[empId].splice(idx, 1);
                showToast(`å·²å–æ¶ˆ ${day} æ—¥è«‹å‡`);
            } else {
                leaves[empId].push(dateStr);
                showToast(`å·²è¨­å®š ${day} æ—¥è«‹å‡`);
            }

            renderLeaveCalendar();
        }

        function clearEmployeeLeave() {
            const empId = parseInt(document.getElementById('leave-employee-select').value);
            const emp = employees.find(e => e.id === empId);
            
            if (!emp) return;
            
            if (confirm(`ç¢ºå®šè¦æ¸…é™¤ã€Œ${emp.name}ã€çš„æ‰€æœ‰è«‹å‡å—ï¼Ÿ`)) {
                leaves[empId] = [];
                showToast(`å·²æ¸…é™¤ã€Œ${emp.name}ã€çš„æ‰€æœ‰è«‹å‡`);
                renderLeaveCalendar();
            }
        }

        // ===== PERSONAL SCHEDULE =====
        function renderPersonalSchedule() {
            const container = document.getElementById('personal-schedule-content');
            const empId = parseInt(document.getElementById('personal-employee-select').value);
            
            if (!empId) {
                container.innerHTML = '<p style="color: var(--gray-500);">è«‹å…ˆé¸æ“‡å“¡å·¥</p>';
                return;
            }

            const emp = employees.find(e => e.id === empId);
            if (!emp) return;

            const daysInMonth = getDaysInMonth(currentYear, currentMonth);
            const target = settings.targetSessions;
            
            // Calculate stats
            let totalSessions = 0;
            let counterCount = 0;
            let followCount = 0;
            let floaterCount = 0;
            let workDays = new Set();

            // Build schedule data
            const scheduleData = [];
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = formatDate(day);
                const sessions = getSessionsForDay(day);
                const weekday = getWeekdayName(day);
                
                const dayData = {
                    day,
                    dateStr,
                    weekday,
                    sessions: []
                };

                if (sessions.length === 0) {
                    dayData.isOff = true;
                    dayData.offReason = isSunday(day) ? 'é€±æ—¥' : 'åœ‹å®šå‡æ—¥';
                } else {
                    sessions.forEach(session => {
                        const key = `${dateStr}_${session}`;
                        const cellData = schedule[key] || { counter: [], follow: [], floater: [] };
                        
                        let role = null;
                        if (cellData.counter.includes(empId)) {
                            role = 'counter';
                            counterCount++;
                            totalSessions++;
                            workDays.add(day);
                        } else if (cellData.follow.includes(empId)) {
                            role = 'follow';
                            followCount++;
                            totalSessions++;
                            workDays.add(day);
                        } else if (cellData.floater && cellData.floater.includes(empId)) {
                            role = 'floater';
                            floaterCount++;
                            totalSessions++;
                            workDays.add(day);
                        }
                        
                        dayData.sessions.push({
                            session,
                            sessionName: SESSION_NAMES[session],
                            role
                        });
                    });
                }
                
                scheduleData.push(dayData);
            }

            const roleDisplay = getRoleDisplay(emp);

            // Render
            let html = `
                <div style="margin-bottom: 16px; padding: 12px; background: var(--gray-50); border-radius: 8px;">
                    <strong>é è¨­è·ä½ï¼š</strong> ${roleDisplay}
                </div>
                <div class="personal-stats">
                    <div class="personal-stat-item">
                        <div class="personal-stat-value">${totalSessions}</div>
                        <div class="personal-stat-label">æœ¬æœˆç¸½è¨ºæ•¸</div>
                    </div>
                    <div class="personal-stat-item">
                        <div class="personal-stat-value" style="color: var(--counter);">${counterCount}</div>
                        <div class="personal-stat-label">æ«ƒæª¯ç­</div>
                    </div>
                    <div class="personal-stat-item">
                        <div class="personal-stat-value" style="color: var(--follow);">${followCount}</div>
                        <div class="personal-stat-label">è·Ÿè¨ºç­</div>
                    </div>
                    <div class="personal-stat-item">
                        <div class="personal-stat-value" style="color: #d97706;">${floaterCount}</div>
                        <div class="personal-stat-label">æµå‹•ç­</div>
                    </div>
                    <div class="personal-stat-item">
                        <div class="personal-stat-value">${workDays.size}</div>
                        <div class="personal-stat-label">å‡ºå‹¤å¤©æ•¸</div>
                    </div>
                    <div class="personal-stat-item">
                        <div class="personal-stat-value" style="color: ${totalSessions >= target ? 'var(--success)' : 'var(--danger)'};">
                            ${totalSessions >= target ? 'âœ“' : target - totalSessions}
                        </div>
                        <div class="personal-stat-label">${totalSessions >= target ? 'å·²é”æ¨™' : 'è·ç›®æ¨™'}</div>
                    </div>
                </div>

                <table class="personal-schedule-table">
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>æ˜ŸæœŸ</th>
                            <th>æ—©è¨º 09:30-12:30</th>
                            <th>åˆè¨º 14:00-17:30</th>
                            <th>æ™šè¨º 18:00-21:30</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            scheduleData.forEach(dayData => {
                if (dayData.isOff) {
                    html += `
                        <tr class="off-day">
                            <td>${currentMonth}/${dayData.day}</td>
                            <td>é€±${dayData.weekday}</td>
                            <td colspan="3">${dayData.offReason} - ä¼‘è¨º</td>
                        </tr>
                    `;
                } else {
                    const hasWork = dayData.sessions.some(s => s.role);
                    html += `<tr class="${hasWork ? 'work-day' : ''}">
                        <td>${currentMonth}/${dayData.day}</td>
                        <td>é€±${dayData.weekday}</td>
                    `;
                    
                    ['morning', 'afternoon', 'evening'].forEach(sessionType => {
                        const sessionData = dayData.sessions.find(s => s.session === sessionType);
                        if (!sessionData) {
                            html += `<td class="off-day">-</td>`;
                        } else if (sessionData.role) {
                            let roleText, roleStyle;
                            if (sessionData.role === 'counter') {
                                roleText = 'æ«ƒæª¯';
                                roleStyle = 'background:var(--counter-light);color:var(--counter);';
                            } else if (sessionData.role === 'follow') {
                                roleText = 'è·Ÿè¨º';
                                roleStyle = 'background:var(--follow-light);color:var(--follow);';
                            } else {
                                roleText = 'æµå‹•';
                                roleStyle = 'background:#fef3c7;color:#d97706;';
                            }
                            html += `<td><span class="role-badge" style="${roleStyle}">${roleText}</span></td>`;
                        } else {
                            html += `<td>-</td>`;
                        }
                    });
                    
                    html += '</tr>';
                }
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // ===== SCHEDULE =====
        function renderSchedule() {
            const table = document.getElementById('schedule-table');
            const daysInMonth = getDaysInMonth(currentYear, currentMonth);

            let html = '<thead><tr><th>æ™‚æ®µ</th>';
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = formatDate(day);
                const sunday = isSunday(day);
                const saturday = isSaturday(day);
                const holiday = isHoliday(dateStr);
                const holidayName = getHolidayName(dateStr);

                let headerClass = 'day-header';
                let headerStyle = '';
                if (holiday) {
                    headerClass += ' holiday';
                    headerStyle = 'color: #dc2626;'; // ç´…å­—
                } else if (sunday) {
                    headerClass += ' sunday';
                    headerStyle = 'color: #dc2626;'; // é€±æ—¥ä¹Ÿç”¨ç´…å­—
                } else if (saturday) {
                    headerClass += ' saturday';
                }

                html += `
                    <th class="${headerClass}" style="${headerStyle}">
                        <div class="date" style="${headerStyle}">${day}</div>
                        <div class="weekday" style="${headerStyle}">é€±${getWeekdayName(day)}</div>
                        ${holiday ? `<div style="font-size:9px;color:#dc2626;white-space:nowrap;">${holidayName}</div>` : ''}
                    </th>
                `;
            }
            html += '</tr></thead><tbody>';

            SESSIONS.forEach(session => {
                html += `<tr>
                    <td>
                        <div class="session-label session-${session}">${SESSION_NAMES[session]}</div>
                        <div style="font-size:10px;color:var(--gray-500);">${SESSION_TIMES[session]}</div>
                    </td>`;

                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = formatDate(day);
                    const sessions = getSessionsForDay(day);
                    const key = `${dateStr}_${session}`;
                    const holiday = isHoliday(dateStr);
                    const sunday = isSunday(day);

                    if (!sessions.includes(session)) {
                        const restText = (holiday || sunday) ? 'ä¼‘' : 'ä¼‘';
                        const cellStyle = (holiday || sunday) ? 'color:#dc2626;' : '';
                        html += `<td class="schedule-cell no-session" style="${cellStyle}">${restText}</td>`;
                    } else {
                        const cellData = schedule[key] || { counter: [], follow: [], floater: [] };
                        html += `<td class="schedule-cell" onclick="editCell('${key}')" title="é»æ“Šç·¨è¼¯">
                            <div class="staff-tags">
                                ${renderStaffTags(cellData, session)}
                            </div>
                        </td>`;
                    }
                }
                html += '</tr>';
            });

            html += '</tbody>';
            table.innerHTML = html;
        }

        function renderStaffTags(cellData, session) {
            let html = '';
            const staffReq = getStaffRequirement(session);
            
            cellData.counter.forEach(empId => {
                const emp = employees.find(e => e.id === empId);
                if (emp) {
                    html += `<span class="staff-tag counter" title="æ«ƒæª¯ç­">æ«ƒ:${emp.name}</span>`;
                }
            });

            cellData.follow.forEach(empId => {
                const emp = employees.find(e => e.id === empId);
                if (emp) {
                    html += `<span class="staff-tag follow" title="è·Ÿè¨ºç­">${emp.name}</span>`;
                }
            });

            (cellData.floater || []).forEach(empId => {
                const emp = employees.find(e => e.id === empId);
                if (emp) {
                    html += `<span class="staff-tag" style="background:#fef3c7;color:#d97706;border:1px solid #f59e0b;" title="æµå‹•ç­">æµ:${emp.name}</span>`;
                }
            });

            const counterVacancy = Math.max(0, staffReq.counter - cellData.counter.length);
            const followVacancy = Math.max(0, staffReq.follow - cellData.follow.length);
            const floaterVacancy = Math.max(0, staffReq.floater - (cellData.floater || []).length);

            for (let i = 0; i < counterVacancy; i++) {
                html += `<span class="vacancy-tag">æ«ƒç¼º</span>`;
            }
            for (let i = 0; i < followVacancy; i++) {
                html += `<span class="vacancy-tag">è¨ºç¼º</span>`;
            }
            for (let i = 0; i < floaterVacancy; i++) {
                html += `<span class="vacancy-tag" style="border-color:#f59e0b;color:#d97706;">æµç¼º</span>`;
            }

            return html;
        }

        function editCell(key) {
            const [dateStr, session] = key.split('_');
            const day = parseInt(dateStr.split('-')[2]);
            const staffReq = getStaffRequirement(session);
            
            if (!schedule[key]) {
                schedule[key] = { counter: [], follow: [], floater: [] };
            }
            if (!schedule[key].floater) schedule[key].floater = [];
            
            const cellData = schedule[key];

            document.getElementById('cell-edit-title').textContent = 
                `ç·¨è¼¯ç­æ¬¡ï¼š${currentMonth}æœˆ${day}æ—¥ ${SESSION_NAMES[session]}`;

            let html = `
                <div style="margin-bottom: 20px;">
                    <h4 style="font-size: 14px; color: var(--counter); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <span style="width: 12px; height: 12px; background: var(--counter); border-radius: 3px;"></span>
                        æ«ƒæª¯ç­ï¼ˆéœ€æ±‚ ${staffReq.counter} äººï¼Œå·²é¸ ${cellData.counter.length} äººï¼‰
                    </h4>
                    <div class="checkbox-group">
            `;

            employees.forEach(emp => {
                const isAssignedCounter = cellData.counter.includes(emp.id);
                const isAssignedFollow = cellData.follow.includes(emp.id);
                const isAssignedFloater = cellData.floater.includes(emp.id);
                const isOnLeave = (leaves[emp.id] || []).includes(dateStr);
                const isDisabled = isOnLeave || isAssignedFollow || isAssignedFloater;
                const isPreferred = emp.roles && emp.roles.counter;
                
                let labelClass = 'checkbox-label';
                if (isAssignedCounter) labelClass += ' checked';
                if (isDisabled) labelClass += ' disabled';
                
                html += `
                    <label class="${labelClass}">
                        <input type="checkbox" 
                               ${isAssignedCounter ? 'checked' : ''}
                               ${isDisabled ? 'disabled' : ''}
                               onchange="toggleAssignment('${key}', ${emp.id}, 'counter')">
                        ${emp.name}
                        ${isPreferred ? '<span class="preferred-badge counter">é è¨­</span>' : ''}
                        ${isOnLeave ? '<small style="color:var(--danger);">(è«‹å‡)</small>' : ''}
                        ${isAssignedFollow ? '<small style="color:var(--follow);">(è·Ÿè¨º)</small>' : ''}
                        ${isAssignedFloater ? '<small style="color:#d97706;">(æµå‹•)</small>' : ''}
                    </label>
                `;
            });

            html += `
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <h4 style="font-size: 14px; color: var(--follow); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <span style="width: 12px; height: 12px; background: var(--follow); border-radius: 3px;"></span>
                        è·Ÿè¨ºç­ï¼ˆéœ€æ±‚ ${staffReq.follow} äººï¼Œå·²é¸ ${cellData.follow.length} äººï¼‰
                    </h4>
                    <div class="checkbox-group">
            `;

            employees.forEach(emp => {
                const isAssignedFollow = cellData.follow.includes(emp.id);
                const isAssignedCounter = cellData.counter.includes(emp.id);
                const isAssignedFloater = cellData.floater.includes(emp.id);
                const isOnLeave = (leaves[emp.id] || []).includes(dateStr);
                const isDisabled = isOnLeave || isAssignedCounter || isAssignedFloater;
                const isPreferred = emp.roles && emp.roles.follow;
                
                let labelClass = 'checkbox-label';
                if (isAssignedFollow) labelClass += ' checked';
                if (isDisabled) labelClass += ' disabled';
                
                html += `
                    <label class="${labelClass}">
                        <input type="checkbox" 
                               ${isAssignedFollow ? 'checked' : ''}
                               ${isDisabled ? 'disabled' : ''}
                               onchange="toggleAssignment('${key}', ${emp.id}, 'follow')">
                        ${emp.name}
                        ${isPreferred ? '<span class="preferred-badge follow">é è¨­</span>' : ''}
                        ${isOnLeave ? '<small style="color:var(--danger);">(è«‹å‡)</small>' : ''}
                        ${isAssignedCounter ? '<small style="color:var(--counter);">(æ«ƒæª¯)</small>' : ''}
                        ${isAssignedFloater ? '<small style="color:#d97706;">(æµå‹•)</small>' : ''}
                    </label>
                `;
            });

            html += `
                    </div>
                </div>
                <div>
                    <h4 style="font-size: 14px; color: #d97706; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <span style="width: 12px; height: 12px; background: #f59e0b; border-radius: 3px;"></span>
                        æµå‹•ç­ï¼ˆéœ€æ±‚ ${staffReq.floater} äººï¼Œå·²é¸ ${cellData.floater.length} äººï¼‰
                    </h4>
                    <div class="checkbox-group">
            `;

            employees.forEach(emp => {
                const isAssignedFloater = cellData.floater.includes(emp.id);
                const isAssignedCounter = cellData.counter.includes(emp.id);
                const isAssignedFollow = cellData.follow.includes(emp.id);
                const isOnLeave = (leaves[emp.id] || []).includes(dateStr);
                const isDisabled = isOnLeave || isAssignedCounter || isAssignedFollow;
                const isPreferred = emp.roles && emp.roles.floater;
                
                let labelClass = 'checkbox-label';
                if (isAssignedFloater) labelClass += ' checked';
                if (isDisabled) labelClass += ' disabled';
                
                html += `
                    <label class="${labelClass}">
                        <input type="checkbox" 
                               ${isAssignedFloater ? 'checked' : ''}
                               ${isDisabled ? 'disabled' : ''}
                               onchange="toggleAssignment('${key}', ${emp.id}, 'floater')">
                        ${emp.name}
                        ${isPreferred ? '<span class="preferred-badge" style="background:#f59e0b;">é è¨­</span>' : ''}
                        ${isOnLeave ? '<small style="color:var(--danger);">(è«‹å‡)</small>' : ''}
                        ${isAssignedCounter ? '<small style="color:var(--counter);">(æ«ƒæª¯)</small>' : ''}
                        ${isAssignedFollow ? '<small style="color:var(--follow);">(è·Ÿè¨º)</small>' : ''}
                    </label>
                `;
            });

            html += '</div></div>';

            document.getElementById('cell-edit-content').innerHTML = html;
            openModal('cell-edit-modal');
        }

        function toggleAssignment(key, empId, role) {
            if (!schedule[key]) {
                schedule[key] = { counter: [], follow: [], floater: [] };
            }
            if (!schedule[key].floater) schedule[key].floater = [];

            const idx = schedule[key][role].indexOf(empId);
            if (idx > -1) {
                schedule[key][role].splice(idx, 1);
            } else {
                schedule[key][role].push(empId);
            }

            editCell(key);
            renderSchedule();
            renderStats();
            renderEmployeeList();
        }

        // ===== AUTO SCHEDULE (with role preferences) =====
        function autoSchedule() {
            const totalRequired = calculateTotalRequired();
            if (!confirm(`ç¢ºå®šè¦åŸ·è¡Œæ™ºèƒ½æ’ç­å—ï¼Ÿ\n\né€™å°‡æœƒï¼š\nâ€¢ æ¸…é™¤ç¾æœ‰ç­è¡¨\nâ€¢ ä¾ç…§å“¡å·¥é è¨­è·ä½å„ªå…ˆåˆ†é…\nâ€¢ ç¢ºä¿æ¯è¨ºè‡³å°‘æœ‰1äºº\nâ€¢ ç¼ºé¡å„ªå…ˆå®‰æ’åœ¨æ—©è¨º\n\næœ¬æœˆéœ€æ±‚ï¼š${totalRequired} äººæ¬¡`)) return;

            showLoading();

            setTimeout(() => {
                schedule = {};
                const daysInMonth = getDaysInMonth(currentYear, currentMonth);

                const allSessions = [];
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = formatDate(day);
                    getSessionsForDay(day).forEach(session => {
                        allSessions.push({ day, dateStr, session, key: `${dateStr}_${session}` });
                    });
                }

                allSessions.forEach(({ key }) => {
                    schedule[key] = { counter: [], follow: [], floater: [] };
                });

                const empCounts = {};
                employees.forEach(emp => empCounts[emp.id] = 0);

                const sessionPriority = { evening: 0, afternoon: 1, morning: 2 };
                const sortedSessions = [...allSessions].sort((a, b) => 
                    sessionPriority[a.session] - sessionPriority[b.session]
                );

                sortedSessions.forEach(({ dateStr, session, key }) => {
                    const staffReq = getStaffRequirement(session);
                    
                    // Get available employees for a specific role
                    const getAvailableForRole = (role) => {
                        return employees.filter(emp => {
                            const onLeave = (leaves[emp.id] || []).includes(dateStr);
                            const atTarget = empCounts[emp.id] >= settings.targetSessions;
                            const alreadyAssigned = schedule[key].counter.includes(emp.id) || 
                                                   schedule[key].follow.includes(emp.id) ||
                                                   schedule[key].floater.includes(emp.id);
                            return !onLeave && !atTarget && !alreadyAssigned;
                        }).map(emp => ({
                            id: emp.id,
                            preferred: emp.roles && emp.roles[role],
                            count: empCounts[emp.id]
                        }));
                    };

                    let totalAssignedThisSession = 0;

                    // Assign counter
                    for (let i = 0; i < staffReq.counter; i++) {
                        let available = getAvailableForRole('counter');
                        available.sort((a, b) => {
                            if (a.preferred && !b.preferred) return -1;
                            if (!a.preferred && b.preferred) return 1;
                            return a.count - b.count;
                        });
                        if (available.length > 0) {
                            const id = available[0].id;
                            schedule[key].counter.push(id);
                            empCounts[id]++;
                            totalAssignedThisSession++;
                        }
                    }

                    // Assign follow
                    for (let i = 0; i < staffReq.follow; i++) {
                        let available = getAvailableForRole('follow');
                        available.sort((a, b) => {
                            if (a.preferred && !b.preferred) return -1;
                            if (!a.preferred && b.preferred) return 1;
                            return a.count - b.count;
                        });
                        if (available.length > 0) {
                            const id = available[0].id;
                            schedule[key].follow.push(id);
                            empCounts[id]++;
                            totalAssignedThisSession++;
                        }
                    }

                    // Assign floater
                    for (let i = 0; i < staffReq.floater; i++) {
                        let available = getAvailableForRole('floater');
                        available.sort((a, b) => {
                            if (a.preferred && !b.preferred) return -1;
                            if (!a.preferred && b.preferred) return 1;
                            return a.count - b.count;
                        });
                        if (available.length > 0) {
                            const id = available[0].id;
                            schedule[key].floater.push(id);
                            empCounts[id]++;
                            totalAssignedThisSession++;
                        }
                    }

                    // ç¢ºä¿æ¯è¨ºè‡³å°‘æœ‰1äºº
                    if (totalAssignedThisSession === 0) {
                        let anyAvailable = employees.filter(emp => {
                            const onLeave = (leaves[emp.id] || []).includes(dateStr);
                            const atTarget = empCounts[emp.id] >= settings.targetSessions;
                            return !onLeave && !atTarget;
                        }).map(emp => ({ id: emp.id, count: empCounts[emp.id] }));
                        anyAvailable.sort((a, b) => a.count - b.count);

                        if (anyAvailable.length > 0) {
                            const id = anyAvailable[0].id;
                            schedule[key].follow.push(id);
                            empCounts[id]++;
                        }
                    }
                });

                hideLoading();
                renderAll();

                const totalAssigned = Object.values(empCounts).reduce((a, b) => a + b, 0);
                const totalVacancy = totalRequired - totalAssigned;

                showToast(`æ™ºèƒ½æ’ç­å®Œæˆï¼å·²æ’ ${totalAssigned} äººæ¬¡ï¼Œç¼ºé¡ ${totalVacancy} äººæ¬¡`, 'success');
            }, 100);
        }

        function clearSchedule() {
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç­è¡¨å—ï¼Ÿ')) return;
            schedule = {};
            renderAll();
            showToast('ç­è¡¨å·²æ¸…é™¤');
        }

        // ===== EXCEL EXPORT =====
        function exportToExcel() {
            const daysInMonth = getDaysInMonth(currentYear, currentMonth);
            const target = settings.targetSessions;
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Sheet 1: Full Schedule
            const scheduleData = [];
            
            // Header row
            const headerRow = ['æ™‚æ®µ'];
            for (let day = 1; day <= daysInMonth; day++) {
                headerRow.push(`${currentMonth}/${day} é€±${getWeekdayName(day)}`);
            }
            scheduleData.push(headerRow);
            
            // Data rows
            SESSIONS.forEach(session => {
                const row = [SESSION_NAMES[session]];
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = formatDate(day);
                    const sessions = getSessionsForDay(day);
                    const key = `${dateStr}_${session}`;
                    
                    if (!sessions.includes(session)) {
                        row.push('ä¼‘è¨º');
                    } else {
                        const cellData = schedule[key] || { counter: [], follow: [], floater: [] };
                        const names = [];
                        
                        cellData.counter.forEach(empId => {
                            const emp = employees.find(e => e.id === empId);
                            if (emp) names.push(`[æ«ƒ]${emp.name}`);
                        });
                        
                        cellData.follow.forEach(empId => {
                            const emp = employees.find(e => e.id === empId);
                            if (emp) names.push(emp.name);
                        });

                        (cellData.floater || []).forEach(empId => {
                            const emp = employees.find(e => e.id === empId);
                            if (emp) names.push(`[æµ]${emp.name}`);
                        });
                        
                        row.push(names.length > 0 ? names.join('\n') : 'ç¼ºäºº');
                    }
                }
                scheduleData.push(row);
            });
            
            const ws1 = XLSX.utils.aoa_to_sheet(scheduleData);
            
            // Set column widths
            ws1['!cols'] = [{ wch: 15 }];
            for (let i = 0; i < daysInMonth; i++) {
                ws1['!cols'].push({ wch: 15 });
            }
            
            XLSX.utils.book_append_sheet(wb, ws1, 'å®Œæ•´ç­è¡¨');
            
            // Sheet 2: Statistics
            const statsData = [
                ['å“¡å·¥å§“å', 'é è¨­è·ä½', 'ç¸½è¨ºæ•¸', 'æ«ƒæª¯ç­', 'è·Ÿè¨ºç­', 'æµå‹•ç­', 'ç›®æ¨™', 'ç‹€æ…‹']
            ];
            
            employees.forEach(emp => {
                let counter = 0, follow = 0, floater = 0;
                Object.values(schedule).forEach(cell => {
                    if (cell && cell.counter && cell.counter.includes(emp.id)) counter++;
                    if (cell && cell.follow && cell.follow.includes(emp.id)) follow++;
                    if (cell && cell.floater && cell.floater.includes(emp.id)) floater++;
                });
                const total = counter + follow + floater;
                const status = total >= target ? 'å·²é”æ¨™' : `å·®${target - total}è¨º`;
                const roleDisplay = getRoleDisplay(emp);
                statsData.push([emp.name, roleDisplay, total, counter, follow, floater, target, status]);
            });
            
            const ws2 = XLSX.utils.aoa_to_sheet(statsData);
            ws2['!cols'] = [{ wch: 12 }, { wch: 15 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 8 }, { wch: 12 }];
            XLSX.utils.book_append_sheet(wb, ws2, 'çµ±è¨ˆå ±è¡¨');
            
            // Download
            XLSX.writeFile(wb, `ç‰™é†«è¨ºæ‰€ç­è¡¨_${currentYear}å¹´${currentMonth}æœˆ.xlsx`);
            showToast('Excel å·²åŒ¯å‡ºï¼');
        }

        function exportPersonalExcel() {
            const empId = parseInt(document.getElementById('personal-employee-select').value);
            const emp = employees.find(e => e.id === empId);
            if (!emp) return;

            const daysInMonth = getDaysInMonth(currentYear, currentMonth);
            const target = settings.targetSessions;
            const wb = XLSX.utils.book_new();
            const roleDisplay = getRoleDisplay(emp);
            
            const data = [
                [`${emp.name} - ${currentYear}å¹´${currentMonth}æœˆ å€‹äººç­è¡¨`],
                [`é è¨­è·ä½ï¼š${roleDisplay}`],
                [],
                ['æ—¥æœŸ', 'æ˜ŸæœŸ', 'æ—©è¨º', 'åˆè¨º', 'æ™šè¨º']
            ];
            
            let totalSessions = 0;
            let counterCount = 0, followCount = 0, floaterCount = 0;
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = formatDate(day);
                const sessions = getSessionsForDay(day);
                const weekday = `é€±${getWeekdayName(day)}`;
                
                if (sessions.length === 0) {
                    data.push([`${currentMonth}/${day}`, weekday, 'ä¼‘è¨º', 'ä¼‘è¨º', 'ä¼‘è¨º']);
                } else {
                    const row = [`${currentMonth}/${day}`, weekday];
                    
                    ['morning', 'afternoon', 'evening'].forEach(session => {
                        if (!sessions.includes(session)) {
                            row.push('ä¼‘è¨º');
                        } else {
                            const key = `${dateStr}_${session}`;
                            const cellData = schedule[key] || { counter: [], follow: [], floater: [] };
                            
                            if (cellData.counter.includes(empId)) {
                                row.push('æ«ƒæª¯');
                                counterCount++;
                                totalSessions++;
                            } else if (cellData.follow.includes(empId)) {
                                row.push('è·Ÿè¨º');
                                followCount++;
                                totalSessions++;
                            } else if (cellData.floater && cellData.floater.includes(empId)) {
                                row.push('æµå‹•');
                                floaterCount++;
                                totalSessions++;
                            } else {
                                row.push('-');
                            }
                        }
                    });
                    
                    data.push(row);
                }
            }
            
            data.push([]);
            data.push(['çµ±è¨ˆ', '']);
            data.push(['æœ¬æœˆç¸½è¨ºæ•¸', totalSessions]);
            data.push(['æ«ƒæª¯ç­', counterCount]);
            data.push(['è·Ÿè¨ºç­', followCount]);
            data.push(['æµå‹•ç­', floaterCount]);
            data.push(['ç›®æ¨™è¨ºæ•¸', target]);
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{ wch: 10 }, { wch: 8 }, { wch: 10 }, { wch: 10 }, { wch: 10 }];
            ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 4 } }];
            
            XLSX.utils.book_append_sheet(wb, ws, 'å€‹äººç­è¡¨');
            XLSX.writeFile(wb, `${emp.name}_ç­è¡¨_${currentYear}å¹´${currentMonth}æœˆ.xlsx`);
            showToast(`${emp.name} çš„ç­è¡¨å·²åŒ¯å‡ºï¼`);
        }

        function exportStatsExcel() {
            const wb = XLSX.utils.book_new();
            const target = settings.targetSessions;
            const totalRequired = calculateTotalRequired();
            
            const data = [
                [`${currentYear}å¹´${currentMonth}æœˆ å“¡å·¥æ’ç­çµ±è¨ˆ`],
                [],
                ['å“¡å·¥å§“å', 'é è¨­è·ä½', 'ç¸½è¨ºæ•¸', 'æ«ƒæª¯ç­', 'è·Ÿè¨ºç­', 'æµå‹•ç­', 'ç›®æ¨™è¨ºæ•¸', 'é”æ¨™ç‹€æ…‹', 'å‡ºå‹¤å¤©æ•¸']
            ];
            
            employees.forEach(emp => {
                let counter = 0, follow = 0, floater = 0;
                const workDays = new Set();
                
                Object.entries(schedule).forEach(([key, cell]) => {
                    if (cell) {
                        const dateStr = key.split('_')[0];
                        if (cell.counter && cell.counter.includes(emp.id)) {
                            counter++;
                            workDays.add(dateStr);
                        }
                        if (cell.follow && cell.follow.includes(emp.id)) {
                            follow++;
                            workDays.add(dateStr);
                        }
                        if (cell.floater && cell.floater.includes(emp.id)) {
                            floater++;
                            workDays.add(dateStr);
                        }
                    }
                });
                
                const total = counter + follow + floater;
                const status = total >= target ? 'âœ“ å·²é”æ¨™' : `å·® ${target - total} è¨º`;
                const roleDisplay = getRoleDisplay(emp);
                data.push([emp.name, roleDisplay, total, counter, follow, floater, target, status, workDays.size]);
            });
            
            const totalAssigned = employees.reduce((sum, emp) => sum + countEmployeeSessions(emp.id), 0);
            data.push([]);
            data.push(['ç¸½è¨ˆ', '', totalAssigned, '', '', '', '', '', '']);
            data.push(['éœ€æ±‚äººæ¬¡', '', totalRequired]);
            data.push(['ç¼ºé¡äººæ¬¡', '', totalRequired - totalAssigned]);
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{ wch: 12 }, { wch: 15 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 12 }, { wch: 10 }];
            ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 8 } }];
            
            XLSX.utils.book_append_sheet(wb, ws, 'çµ±è¨ˆå ±è¡¨');
            XLSX.writeFile(wb, `æ’ç­çµ±è¨ˆ_${currentYear}å¹´${currentMonth}æœˆ.xlsx`);
            showToast('çµ±è¨ˆå ±è¡¨å·²åŒ¯å‡ºï¼');
        }

        // ===== STATS =====
        function countEmployeeSessions(empId) {
            let count = 0;
            Object.values(schedule).forEach(cell => {
                if (cell && cell.counter && cell.counter.includes(empId)) count++;
                if (cell && cell.follow && cell.follow.includes(empId)) count++;
                if (cell && cell.floater && cell.floater.includes(empId)) count++;
            });
            return count;
        }

        function renderStats() {
            const grid = document.getElementById('stats-grid');
            const target = settings.targetSessions;
            
            // Update target display
            const targetDisplay = document.getElementById('stats-target-display');
            if (targetDisplay) targetDisplay.textContent = target;
            
            grid.innerHTML = employees.map(emp => {
                const count = countEmployeeSessions(emp.id);
                let statusClass = '';
                let statusIcon = '';
                
                if (count === target) {
                    statusClass = 'complete';
                    statusIcon = 'âœ“';
                } else if (count > target) {
                    statusClass = 'over';
                    statusIcon = 'âš ';
                } else {
                    statusClass = 'under';
                    statusIcon = '';
                }

                return `
                    <div class="stat-card ${statusClass}">
                        <div class="stat-name">${emp.name} ${statusIcon}</div>
                        <div class="stat-value">${count}</div>
                        <div class="stat-target">/ ${target} è¨º</div>
                    </div>
                `;
            }).join('');

            const totalAssigned = employees.reduce((sum, emp) => sum + countEmployeeSessions(emp.id), 0);
            const totalRequired = calculateTotalRequired();
            document.getElementById('total-required').textContent = totalRequired;
            document.getElementById('total-assigned').textContent = totalAssigned;
            document.getElementById('total-vacancy').textContent = Math.max(0, totalRequired - totalAssigned);
        }

        // ===== MODAL =====
        function openModal(id) {
            document.getElementById(id).classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
            document.body.style.overflow = '';
        }

        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                    modal.classList.remove('active');
                });
                document.body.style.overflow = '';
            }
        });

        // ===== TAB =====
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`panel-${tabName}`).classList.add('active');

            if (tabName === 'leave') renderLeaveCalendar();
            if (tabName === 'stats') renderStats();
            if (tabName === 'employees') renderEmployeeList();
            if (tabName === 'personal') renderPersonalSchedule();
            if (tabName === 'settings') {
                renderSettingsSummary();
                renderHolidayList();
            }
        }

        // ===== SETTINGS =====
        function updateTargetSessions() {
            const input = document.getElementById('target-sessions-input');
            const value = parseInt(input.value) || 42;
            settings.targetSessions = Math.max(1, Math.min(100, value));
            input.value = settings.targetSessions;
            renderSettingsSummary();
            renderStats();
            renderEmployeeList();
            showToast(`ç›®æ¨™è¨ºæ•¸å·²æ›´æ–°ç‚º ${settings.targetSessions} è¨º`);
        }

        function updateStaffSettings() {
            settings.staffPerSession = {
                morning: {
                    counter: parseInt(document.getElementById('morning-counter').value) || 0,
                    follow: parseInt(document.getElementById('morning-follow').value) || 0,
                    floater: parseInt(document.getElementById('morning-floater').value) || 0
                },
                afternoon: {
                    counter: parseInt(document.getElementById('afternoon-counter').value) || 0,
                    follow: parseInt(document.getElementById('afternoon-follow').value) || 0,
                    floater: parseInt(document.getElementById('afternoon-floater').value) || 0
                },
                evening: {
                    counter: parseInt(document.getElementById('evening-counter').value) || 0,
                    follow: parseInt(document.getElementById('evening-follow').value) || 0,
                    floater: parseInt(document.getElementById('evening-floater').value) || 0
                }
            };
            renderSettingsSummary();
            renderStats();
            showToast('äººåŠ›éœ€æ±‚è¨­å®šå·²æ›´æ–°');
        }

        function renderSettingsSummary() {
            const container = document.getElementById('settings-summary');
            const totalRequired = calculateTotalRequired();
            const totalSupply = employees.length * settings.targetSessions;
            const diff = totalSupply - totalRequired;
            
            // Count sessions
            const daysInMonth = getDaysInMonth(currentYear, currentMonth);
            let totalSessions = 0;
            for (let day = 1; day <= daysInMonth; day++) {
                totalSessions += getSessionsForDay(day).length;
            }
            
            container.innerHTML = `
                <div style="text-align: center; padding: 12px; background: white; border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: 700; color: var(--primary);">${totalSessions}</div>
                    <div style="font-size: 12px; color: var(--gray-500);">æœ¬æœˆç¸½è¨ºæ•¸</div>
                </div>
                <div style="text-align: center; padding: 12px; background: white; border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: 700; color: var(--primary);">${totalRequired}</div>
                    <div style="font-size: 12px; color: var(--gray-500);">éœ€æ±‚äººæ¬¡</div>
                </div>
                <div style="text-align: center; padding: 12px; background: white; border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: 700; color: var(--primary);">${employees.length}</div>
                    <div style="font-size: 12px; color: var(--gray-500);">å“¡å·¥äººæ•¸</div>
                </div>
                <div style="text-align: center; padding: 12px; background: white; border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: 700; color: var(--primary);">${totalSupply}</div>
                    <div style="font-size: 12px; color: var(--gray-500);">ä¾›æ‡‰äººæ¬¡</div>
                </div>
                <div style="text-align: center; padding: 12px; background: white; border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: 700; color: ${diff >= 0 ? 'var(--success)' : 'var(--danger)'};">${diff >= 0 ? '+' : ''}${diff}</div>
                    <div style="font-size: 12px; color: var(--gray-500);">${diff >= 0 ? 'äººåŠ›é¤˜è£•' : 'äººåŠ›ç¼ºå£'}</div>
                </div>
            `;
        }

        // ===== YEAR/MONTH CHANGE =====
        function changeYearMonth() {
            const newYear = parseInt(document.getElementById('year-select').value);
            const newMonth = parseInt(document.getElementById('month-select').value);
            
            if (newYear === currentYear && newMonth === currentMonth) {
                showToast('å¹´æœˆæœªè®Šæ›´', 'warning');
                return;
            }
            
            if (!confirm(`ç¢ºå®šè¦åˆ‡æ›åˆ° ${newYear}å¹´${newMonth}æœˆ å—ï¼Ÿ\n\nâš ï¸ é€™å°‡æ¸…é™¤ç¾æœ‰çš„ç­è¡¨å’Œè«‹å‡è³‡æ–™ï¼`)) {
                // Reset select to current values
                document.getElementById('year-select').value = currentYear;
                document.getElementById('month-select').value = currentMonth;
                return;
            }
            
            currentYear = newYear;
            currentMonth = newMonth;
            
            // Clear schedule and leaves
            schedule = {};
            leaves = {};
            
            // Update all displays
            updateYearMonthDisplay();
            renderHolidayList();
            renderAll();
            
            showToast(`å·²åˆ‡æ›è‡³ ${currentYear}å¹´${currentMonth}æœˆ`, 'success');
        }

        function updateYearMonthDisplay() {
            const yearMonthText = `${currentYear}å¹´${currentMonth}æœˆ`;
            
            document.getElementById('header-year-month').textContent = yearMonthText;
            document.getElementById('schedule-year-month').textContent = yearMonthText;
            document.getElementById('leave-year-month').textContent = yearMonthText;
            
            // Update select values
            document.getElementById('year-select').value = currentYear;
            document.getElementById('month-select').value = currentMonth;
            
            // Update document title
            document.title = `ç‰™é†«è¨ºæ‰€æ’ç­ç³»çµ± - ${yearMonthText}`;
        }

        function renderHolidayList() {
            const container = document.getElementById('holiday-list');
            const daysInMonth = getDaysInMonth(currentYear, currentMonth);
            let html = '';
            let hasHoliday = false;
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = formatDate(day);
                if (isHoliday(dateStr)) {
                    hasHoliday = true;
                    const holidayName = getHolidayName(dateStr);
                    html += `
                        <div style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; color: #dc2626;">
                            <span style="font-weight: 600;">${currentMonth}/${day}</span>
                            <span>${holidayName}</span>
                        </div>
                    `;
                }
            }
            
            if (!hasHoliday) {
                html = '<div style="color: var(--gray-500); font-size: 14px;">æœ¬æœˆç„¡åœ‹å®šå‡æ—¥</div>';
            }
            
            container.innerHTML = html;
        }

        // ===== RENDER ALL =====
        function renderAll() {
            renderEmployeeList();
            renderSchedule();
            renderStats();
            renderLeaveCalendar();
            renderPersonalSchedule();
            renderSettingsSummary();
            renderHolidayList();
        }

        // ===== INIT =====
        function init() {
            updateYearMonthDisplay();
            renderAll();
            console.log('ç‰™é†«è¨ºæ‰€æ’ç­ç³»çµ± V5 å·²è¼‰å…¥');
        }

        document.getElementById('employee-name-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                saveEmployee();
            }
        });

        init();
    </script>
</body>
</html>
